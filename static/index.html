<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
</head>

<body>
    <h1>hello signalizer</h1>

    <fieldset>
        <input type="text" name="channelName" id="channelName">
        <hr />
        <input type="button" value="connect" onclick="API.connect()">
        <input type="button" value="join" onclick="API.join()">
        <input type="button" value="list" onclick="API.list()">
        <input type="button" value="disconnect" onclick="API.disconnect()">
        <input type="button" value="shutdown" onclick="API.shutdown()">
    </fieldset>

    <script>
        // @ts-check
        {
            let connection;

            const connect = () => {
                const protocol = window.location.protocol == 'https:' && 'wss://' || 'ws://';
                const wsUri = protocol + window.location.host + '/ws/';
                const socket = new WebSocket(wsUri);
                socket.onmessage = ({ data, timeStamp, origin }) => {
                    // console.table({ timeStamp, origin });
                    try {
                        const payload = JSON.parse(data);
                        console.debug(payload);
                    } catch (error) {
                        console.error("can't parse payload", { payload: data , error});
                    }
                };
                socket.onerror = (error) => console.error(error);
                socket.onclose = (error) => console.warn("closed", error);
                connection = socket

                console.info({ protocol, wsUri, connection })
            };

            const disconnect = () => {
                connection.close();
            };

            const changeChannel = (name) => {
                console.debug({ name });
            };

            const join = () => connection.send(JSON.stringify({
                kind: { join: { room: API.channelName } }
            }));

            const list = () => connection.send(JSON.stringify({
                kind: "listRooms"
            }));

            const shutdown = () => connection.send(JSON.stringify({
                kind: "shutDown"
            }));

            const API = {
                channelName: 'default',
                connect, disconnect,
                join, list, shutdown
            };

            document.querySelector('input#channelName').placeholder = API.channelName;
            document.querySelector('input#channelName').onkeyup = ({ target: { value } }) => API.channelName = value;
            if (!!document.querySelector('input#channelName').value) {
                API.channelName = document.querySelector('input#channelName').value
                console.debug(`reusing channelName ${API.channelName}`);
            } 
            window.API = API;
        }

    </script>
</body>

</html>